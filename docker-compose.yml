services:
  mc-forge:
    image: itzg/minecraft-server:java8
    container_name: mc-forge
    ports:
      - "25565:25565"
      - "25575:25575"  # RCON port for alternative method
    environment:
      EULA: "TRUE"
      TYPE: "FORGE"
      VERSION: "1.8.9"
      MEMORY: "8G"
      ENABLE_RCON: "TRUE"
      RCON_PASSWORD: "minecraft"
    volumes:
      - ./server:/data
    restart: unless-stopped


  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - ENV=production
    depends_on:
      - mc-forge
    volumes:
      - /var/run/docker.sock:/v
    deploy:
      resources:
        limits:
          cpus: '4.0'
        reservations:
          cpus: '3.0' 


  headlessmc1:
    build: ./headlessmc
    container_name: headlessmc1
    stdin_open: true
    tty: true
    environment:
      # Offline mode: EMAIL and PASSWORD are empty (no login required)
      - EMAIL=
      - PASSWORD=
      - SERVER=mc-forge:25565
      - USERNAME=Bot1
      # Use virtual framebuffer (xvfb) for headless rendering (set to false to disable)
      - USE_XVFB=false
    depends_on:
      - mc-forge
    volumes:
      # Persist HeadlessMC downloads (shared)
      - headlessmc-data:/opt/hmc/HeadlessMC
      # Separate game directory for each bot
      - headlessmc1-gamedir:/opt/hmc/run


  headlessmc2:
    build: ./headlessmc
    container_name: headlessmc2
    stdin_open: true
    tty: true
    environment:
      # Offline mode: EMAIL and PASSWORD are empty (no login required)
      - EMAIL=
      - PASSWORD=
      - SERVER=mc-forge:25565
      - USERNAME=Bot2
      # Use virtual framebuffer (xvfb) for headless rendering (set to false to disable)
      - USE_XVFB=false
    depends_on:
      - mc-forge
    volumes:
      # Persist HeadlessMC downloads (shared)
      - headlessmc-data:/opt/hmc/HeadlessMC
      # Separate game directory for each bot
      - headlessmc2-gamedir:/opt/hmc/run






  #mineflayer-bots:
   # build: ./mineflayer  # Ensure this is pointing to the correct directory with your bot's Dockerfile
   # environment:
    #  - BOT_COUNT=1  # Set the number of bots you want to run here
    #depends_on:
    #  - mc-forge
    #entrypoint: ["sh", "-c", "echo 'Waiting for Minecraft server to start...';until nc -z -v -w30 mc-forge 25565; do sleep 5; done;echo 'Port 25565 is open, waiting for server to be fully ready...';sleep 3;exec sh start.sh"]


volumes:
  headlessmc-data:
  headlessmc1-gamedir:
  headlessmc2-gamedir:
